<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞—Ñ–∏–∫ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤–æ–¥—ã</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background-color: #f0f8ff;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 105, 148, 0.1);
            padding: 25px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1f5fe;
        }
        
        h1 {
            color: #024b7b;
            margin-bottom: 10px;
        }
        
        .description {
            color: #666;
            max-width: 800px;
            margin: 0 auto 20px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8fdff;
            border-radius: 10px;
            border: 1px solid #e1f5fe;
        }
        
        .period-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e3f2fd;
            border: 2px solid #81d4fa;
            cursor: pointer;
            font-size: 18px;
            color: #01579b;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-btn:hover {
            background-color: #b3e5fc;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #e0e0e0;
            border-color: #bdbdbd;
        }
        
        .period-display {
            font-weight: 600;
            color: #024b7b;
            font-size: 18px;
            min-width: 300px;
            text-align: center;
        }
        
        .interval-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .interval-selector label {
            font-weight: 600;
            color: #024b7b;
        }
        
        .interval-btn {
            padding: 10px 20px;
            background-color: #e3f2fd;
            border: 2px solid #81d4fa;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #01579b;
            transition: all 0.3s ease;
        }
        
        .interval-btn:hover {
            background-color: #b3e5fc;
        }
        
        .interval-btn.active {
            background-color: #024b7b;
            color: white;
            border-color: #024b7b;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            color: #0277bd;
            width: 100%;
            margin-top: 10px;
        }
        
        .file-upload-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .file-input-label {
            padding: 10px 15px;
            background-color: #0277bd;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .file-input-label:hover {
            background-color: #0277bd;
        }
        
        .file-input {
            display: none;
        }
        
        .current-file {
            font-style: italic;
            color: #666;
        }
        
		.stats {
		    display: flex;
		    flex-wrap: wrap;
		    justify-content: space-around;
		    gap: 20px;
		    margin-bottom: 30px;
		}

		.stat-card {
		    flex: 1;
		    min-width: 200px;
		    padding: 5px 15px 8px 15px;
		    border-radius: 10px;
		    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
		    display: flex;
		    flex-direction: column;
		}

		.stat-card h3 {
		    color: #333;
		    margin-bottom: 5px;
		    font-size: 14px;
		    text-align: center;
		    font-weight: 600;
		}

		.stat-card .stat-item {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    margin-bottom: 1px;
		    padding-bottom: 1px;
		    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
		}

		.stat-card .stat-item:last-child {
		    border-bottom: none;
		    margin-bottom: 0;
		    padding-bottom: 0;
		}

		.stat-card .stat-label {
		    font-size: 12px;
		    color: #666;
		    flex: 1;
		    line-height: 1.4;
		}

		.stat-card .stat-value {
		    font-size: 14px;
		    font-weight: 700;
		    color: #333;
		    flex: 0 0 auto;
		    margin-left: 10px;
		    text-align: right;
		    min-width: 80px;
		}

		.stat-card .max-date {
		    font-size: 12px;
		    color: #888;
		    text-align: center;
		    margin-top: 8px;
		    width: 100%;
		    font-style: italic;
		}

		/* –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
		.stat-card.water {
		    background-color: #e8f4fc;
		    border-left: 5px solid #024b7b;
		}

		.stat-card.other-water {
		    background-color: #f0f9f0;
		    border-left: 5px solid #2e7d32;
		}

		.stat-card.combined {
		    background-color: #fff8e1;
		    border-left: 5px solid #ff8f00;
		}
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        
        .data-format {
            background-color: #f8fdff;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1f5fe;
            margin-top: 30px;
        }
        
        .data-format h3 {
            color: #0277bd;
            margin-bottom: 10px;
        }
        
        .data-format code {
            background-color: #f1f8ff;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1f5fe;
            color: #888;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .period-navigation {
                order: 1;
                width: 100%;
                justify-content: center;
            }
            
            .interval-selector {
                order: 2;
                flex-direction: column;
                gap: 10px;
            }
            
            .file-info {
                order: 3;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .period-display {
                min-width: 200px;
                font-size: 14px;
            }
			
			h1{
			font-size: 18px;	
			}
			
			 .container {
				padding: 15px;  
			 }
			 
			 body {
				padding: 15px;  
			 }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–ì—Ä–∞—Ñ–∏–∫ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤–æ–¥—ã</h1>
         <div id="no-data-message" class="no-data">
             <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
			 <p id="ios-help" style="display: none; color: #ff6b6b; margin-top: 10px;">
         </div>
        </header>
        
        
        
        <div class="stats" id="stats-container" style="display: none;">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </div>
        
        <div class="chart-container">
            <canvas id="waterChart"></canvas>
        </div>
        
        <div class="controls">
            <div class="period-navigation">
                <button class="nav-btn" id="prev-period" disabled>‚Üê</button>
                <div class="period-display" id="period-display">...</div>
                <button class="nav-btn" id="next-period" disabled>‚Üí</button>
            </div>
            
            <div class="interval-selector">
                <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª:</label>
                <div>
                    <button class="interval-btn active" data-days="7" disabled>7 –¥–Ω–µ–π</button>
                    <button class="interval-btn" data-days="30" disabled>30 –¥–Ω–µ–π</button>
                </div>
            </div>
            
            
        </div>
		
        <div class="file-upload-container">
            <label for="data-file" class="file-input-label">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö</label>
            <input type="file" id="data-file" class="file-input" accept=".txt">
            <div class="current-file" id="current-file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
        </div>
		
        
        
        
        
        <footer>
            
        </footer>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const intervalButtons = document.querySelectorAll('.interval-btn');
        const prevPeriodBtn = document.getElementById('prev-period');
        const nextPeriodBtn = document.getElementById('next-period');
        const periodDisplay = document.getElementById('period-display');
        const chartCanvas = document.getElementById('waterChart');
        const noDataMessage = document.getElementById('no-data-message');
        const statsContainer = document.getElementById('stats-container');
        const fileInput = document.getElementById('data-file');
        const fileNameDisplay = document.getElementById('current-file-name');
		const iosHelp = document.getElementById('ios-help');
		// –ü—Ä–æ–≤–µ—Ä—è–µ–º iOS
		const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏ –≥—Ä–∞—Ñ–∏–∫–∞
        let waterData = [];
        let groupedDailyData = [];
        let currentDaysInterval = 7;
        let currentStartIndex = 0; // –ò–Ω–¥–µ–∫—Å –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        let waterChart = null;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
        intervalButtons.forEach(button => {
            button.addEventListener('click', function() {
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                intervalButtons.forEach(btn => btn.classList.remove('active'));
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –Ω–∞ –Ω–∞–∂–∞—Ç—É—é –∫–Ω–æ–ø–∫—É
                this.classList.add('active');
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
                currentDaysInterval = parseInt(this.getAttribute('data-days'));
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥
                resetToLastPeriod();
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
                updateChart();
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        prevPeriodBtn.addEventListener('click', () => {
            moveToPreviousPeriod();
            updateChart();
        });
        
        nextPeriodBtn.addEventListener('click', () => {
            moveToNextPeriod();
            updateChart();
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
				fileNameDisplay.textContent = `–ó–∞–≥—Ä—É–∂–∞–µ–º: ${file.name}`;
				// –î–ª—è iOS –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
				if (isIOS) {
				setTimeout(() => readFile(file), 100);
			    } else {
				 readFile(file);
				}
            }
        });
        
        // –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
        function readFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
				try {
                    const dataString = e.target.result;
                  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
                  if (!dataString || dataString.trim() === '') {
                       throw new Error('–§–∞–π–ª –ø—É—Å—Ç–æ–π');
                  }
                   
                   processData(dataString);
				                    fileNameDisplay.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω: ${file.name}`;
				                   enableControls();
				                    
				                    // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è iOS –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
				                    iosHelp.style.display = 'none';
				                } catch (error) {
				                   console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞:', error);
				                   showError(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${error.message}`);
				                }
            };
            
            reader.onerror = function() {
				showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
				                if (isIOS) {
				                    iosHelp.style.display = 'block';
				                }
				            };
				            
				            reader.onabort = function() {
				               showError('–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø—Ä–µ—Ä–≤–∞–Ω–æ');
            };
            
			try {
			                reader.readAsText(file, 'UTF-8');
			            } catch (error) {
			                showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª: ${error.message}`);
			            }
			        }
			        
			        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
			        function showError(message) {
			            fileNameDisplay.textContent = message;
			            fileNameDisplay.style.color = '#ff6b6b';
			            
			            // –°–±—Ä–æ—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
			            setTimeout(() => {
			                fileNameDisplay.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
			                fileNameDisplay.style.color = '';
			            }, 3000);
        }
        
        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function enableControls() {
            intervalButtons.forEach(btn => btn.disabled = false);
			            prevPeriodBtn.disabled = false;
			            nextPeriodBtn.disabled = false;
        }
        
        // –°–±—Ä–æ—Å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø–µ—Ä–∏–æ–¥—É
        function resetToLastPeriod() {
            if (groupedDailyData.length === 0) return;
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª–æ —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
            currentStartIndex = Math.max(0, groupedDailyData.length - currentDaysInterval);
        }
        
        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –ø–µ—Ä–∏–æ–¥—É (–±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏–µ –¥–∞—Ç—ã)
        function moveToPreviousPeriod() {
            if (groupedDailyData.length === 0) return;
            // –°–¥–≤–∏–≥–∞–µ–º—Å—è –Ω–∞–∑–∞–¥ –Ω–∞ —Ç–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            currentStartIndex = Math.max(0, currentStartIndex - currentDaysInterval);
        }
        
        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–µ—Ä–∏–æ–¥—É (–±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–∏–µ –¥–∞—Ç—ã)
        function moveToNextPeriod() {
            if (groupedDailyData.length === 0) return;
            // –°–¥–≤–∏–≥–∞–µ–º—Å—è –≤–ø–µ—Ä–µ–¥ –Ω–∞ —Ç–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            currentStartIndex = Math.min(
                groupedDailyData.length - currentDaysInterval, 
                currentStartIndex + currentDaysInterval
            );
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ –î–î.–ú–ú.–ì–ì–ì–ì –≤ YYYY-MM-DD –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function parseCustomDate(dateStr) {
            const parts = dateStr.split('.');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateStr;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞
        function processData(dataString) {
		    try {
		                  const lines = dataString.trim().split('\n');
		                   waterData = [];
		                   
		                   let lineNumber = 0;
		                   for (const line of lines) {
		                       lineNumber++;
		                       const trimmedLine = line.trim();
		                       if (trimmedLine === '') continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
		                       
		                       const parts = trimmedLine.split(';');
		                       if (parts.length < 4) {
		                           console.warn(`–°—Ç—Ä–æ–∫–∞ ${lineNumber} –ø—Ä–æ–ø—É—â–µ–Ω–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç`);
		                           continue;
		                       }
		                       
		                       const dateStr = parts[0].trim();
		                       const timeStr = parts[1].trim();
                    const water = parseInt(parts[2]) || 0;
                    const otherWater = parseInt(parts[3]) || 0;
                    const totalWater = water + otherWater;
                    
					// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã
					                    if (!/^\d{2}\.\d{2}\.\d{4}$/.test(dateStr)) {
					                        console.warn(`–°—Ç—Ä–æ–∫–∞ ${lineNumber}: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: ${dateStr}`);
					                        continue;
					                    }
                    
                    const isoDateStr = parseCustomDate(dateStr);
                    const dateTime = new Date(`${isoDateStr}T${timeStr}`);
                    
                    waterData.push({
                        originalDate: dateStr, // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã
                        date: isoDateStr, // –∏—Å–ø–æ–ª—å–∑—É–µ–º ISO —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                        time: timeStr,
                        dateTime: dateTime,
                        water: water,
                        otherWater: otherWater,
                        total: totalWater
                    });
                }
			    if (waterData.length === 0) {
			                       throw new Error('–ù–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ');
			                   }
			                   
			                   // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ
			                   waterData.sort((a, b) => a.dateTime - b.dateTime);
			                   
			                   // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º
			                   groupedDailyData = groupDataByDay(waterData);
			                   
			                   // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥
			                   resetToLastPeriod();
			                   
			                   // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
			                   updateChart();
			                   
			               } catch (error) {
			                   console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
			                   throw error;
			               }
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–Ω—è–º
        function groupDataByDay(data) {
            const grouped = {};
            
            data.forEach(entry => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
                const date = entry.originalDate;
                
                if (!grouped[date]) {
                    grouped[date] = {
                        originalDate: date,
                        date: entry.date,
                        total: 0,
                        water: 0,
                        otherWater: 0,
                        count: 0
                    };
                }
                
                grouped[date].total += entry.total;
                grouped[date].water += entry.water;
                grouped[date].otherWater += entry.otherWater;
                grouped[date].count++;
            });
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
            return Object.values(grouped).sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        function getCurrentPeriodData() {
            if (groupedDailyData.length === 0) return [];
            
            // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å
            const endIndex = Math.min(currentStartIndex + currentDaysInterval, groupedDailyData.length);
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            return groupedDailyData.slice(currentStartIndex, endIndex);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        function updatePeriodDisplay() {
            if (groupedDailyData.length === 0) {
                periodDisplay.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏';
                prevPeriodBtn.disabled = true;
                nextPeriodBtn.disabled = true;
                return;
            }
            
            const periodData = getCurrentPeriodData();
            
            if (periodData.length === 0) {
                periodDisplay.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞';
                prevPeriodBtn.disabled = true;
                nextPeriodBtn.disabled = true;
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞
            const startDate = periodData[0]?.originalDate || '';
            const endDate = periodData[periodData.length - 1]?.originalDate || '';
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            let displayText;
            if (startDate && endDate) {
                const isLastPeriod = (currentStartIndex + currentDaysInterval) >= groupedDailyData.length;
                
                if (isLastPeriod) {
                    displayText = `–ü–æ—Å–ª–µ–¥–Ω–∏–µ ${periodData.length} –¥–Ω–µ–π`;
                } else {
                    displayText = `${startDate} - ${endDate}`;
                }
            } else {
                displayText = `–ü–µ—Ä–∏–æ–¥: ${periodData.length} –∏–∑ ${groupedDailyData.length} –¥–Ω–µ–π`;
            }
            
            periodDisplay.textContent = displayText;
            
            // –£–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            prevPeriodBtn.disabled = currentStartIndex === 0;
            nextPeriodBtn.disabled = (currentStartIndex + currentDaysInterval) >= groupedDailyData.length;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        function updateChart() {
            if (groupedDailyData.length === 0) {
                noDataMessage.style.display = 'block';
                chartCanvas.style.display = 'none';
                statsContainer.style.display = 'none';
                return;
            }
            
            noDataMessage.style.display = 'none';
            chartCanvas.style.display = 'block';
            statsContainer.style.display = 'flex';
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            const periodData = getCurrentPeriodData();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞
            updatePeriodDisplay();
            
            const labels = periodData.map(item => item.originalDate);
            const waterOnly = periodData.map(item => item.water);
            const otherWater = periodData.map(item => item.otherWater);
            
            // –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–Ω–∏—á—Ç–æ–∂–∞–µ–º –µ–≥–æ
            if (waterChart) {
                waterChart.destroy();
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
            const ctx = chartCanvas.getContext('2d');
            waterChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '–í—ã–ø–∏–ª',
                            data: waterOnly,
                            backgroundColor: '#44b7c2',
                            borderColor: '#1a8791',
                            borderWidth: 1
                        },
                        {
                            label: '–í—ã—à–ª–æ',
                            data: otherWater,
                            backgroundColor: '#ffad49',
                            borderColor: '#db841a',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y + ' –º–ª';
                                    return label;
                                },
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const total = waterOnly[context.dataIndex] + otherWater[context.dataIndex];
                                        return `–í—Å–µ–≥–æ: ${total} –º–ª`;
                                    }
                                    return null;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: false,
                                text: '–î–∞—Ç–∞',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: false,
                                text: '–û–±—ä–µ–º (–º–ª)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' –º–ª';
                                }
                            }
                        }
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateStatistics();
        }
        
		// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
		function updateStatistics() {
		    if (groupedDailyData.length === 0) return;
    
		    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
		    const periodData = getCurrentPeriodData();
    
		    if (periodData.length === 0) {
		        statsContainer.innerHTML = `
            <div class="stat-card water">
                <h3>–û—Å–Ω–æ–≤–Ω–∞—è –≤–æ–¥–∞</h3>
                <div class="stat-item">
                    <span class="stat-label">–í—Å–µ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</span>
                    <span class="stat-value">0 –º–ª</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</span>
                    <span class="stat-value">0 –º–ª</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–ú–∞–∫—Å–∏–º—É–º</span>
                    <span class="stat-value">0 –º–ª</span>
                </div>
                <div class="max-date">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
            </div>
            <div class="stat-card other-water">
                <h3>–î—Ä—É–≥–∞—è –≤–æ–¥–∞</h3>
                <div class="stat-item">
                    <span class="stat-label">–í—Å–µ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</span>
                    <span class="stat-value">0 –º–ª</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</span>
                    <span class="stat-value">0 –º–ª</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–ú–∞–∫—Å–∏–º—É–º</span>
                    <span class="stat-value">0 –º–ª</span>
                </div>
                <div class="max-date">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
            </div>
		        `;
		        return;
		    }
    
		    // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –û—Å–Ω–æ–≤–Ω–æ–π –≤–æ–¥—ã
		    const totalWater = periodData.reduce((sum, day) => sum + day.water, 0);
		    const averageWater = Math.round(totalWater / periodData.length);
		    const maxWaterDay = periodData.reduce((max, day) => day.water > max.water ? day : max, {water: 0, originalDate: ''});
    
		    // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –î—Ä—É–≥–æ–π –≤–æ–¥—ã
		    const totalOtherWater = periodData.reduce((sum, day) => sum + day.otherWater, 0);
		    const averageOtherWater = Math.round(totalOtherWater / periodData.length);
		    const maxOtherWaterDay = periodData.reduce((max, day) => day.otherWater > max.otherWater ? day : max, {otherWater: 0, originalDate: ''});
    
		    // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –û–±—â–µ–≥–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
		    const totalCombined = periodData.reduce((sum, day) => sum + day.total, 0);
		    const averageCombined = Math.round(totalCombined / periodData.length);
		    const maxCombinedDay = periodData.reduce((max, day) => day.total > max.total ? day : max, {total: 0, originalDate: ''});
    
		    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
		    const formatML = (value) => {
		        if (value >= 1000) {
		            return (value / 1000).toFixed(1) + ' –ª';
		        }
		        return value + ' –º–ª';
		    };
    
		    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
		    statsContainer.innerHTML = `
        <div class="stat-card water">
            <h3>–û—Å–Ω–æ–≤–Ω–∞—è –≤–æ–¥–∞</h3>
            <div class="stat-item">
                <span class="stat-label">–í—Å–µ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</span>
                <span class="stat-value">${formatML(totalWater)}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</span>
                <span class="stat-value">${formatML(averageWater)}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">–ú–∞–∫—Å–∏–º—É–º ${maxWaterDay.originalDate || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</span>
                <span class="stat-value">${formatML(maxWaterDay.water)}</span>
            </div>
         
        </div>
        <div class="stat-card other-water">
            <h3>–î—Ä—É–≥–∞—è –≤–æ–¥–∞</h3>
            <div class="stat-item">
                <span class="stat-label">–í—Å–µ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</span>
                <span class="stat-value">${formatML(totalOtherWater)}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</span>
                <span class="stat-value">${formatML(averageOtherWater)}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">–ú–∞–∫—Å–∏–º—É–º ${maxOtherWaterDay.originalDate || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</span>
                <span class="stat-value">${formatML(maxOtherWaterDay.otherWater)}</span>
            </div>
            
        </div>
		    `;
		}
		
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', function() {
            // –í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã
            prevPeriodBtn.disabled = true;
            nextPeriodBtn.disabled = true;
            intervalButtons.forEach(btn => btn.disabled = true);
        });
    </script>
</body>
</html>
